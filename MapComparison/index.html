<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorateur Historique Multim√©dia d'Oraxia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles Globaux */
        .comparison-slider-container {
            --position: 50%;
            user-select: none;
            cursor: grab;
            touch-action: none; 
        }

        .cursor-grabbing { cursor: grabbing !important; }
        
        .image-apres-wrapper { clip-path: inset(0 0 0 var(--position)); }

        .slider-handle {
            left: var(--position);
            transform: translateX(-50%); 
            touch-action: none; 
        }

        .handle-line { width: 4px; }
        .handle-circle { width: 40px; height: 40px; }
        .handle-content { display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        
        .comparison-image {
            position: absolute;
            width: 100%;
            height: 100%;
            transition: transform 0.15s ease-out;
            transform-origin: 0 0; 
        }
        
        /* POI Styles */
        .poi-pin {
            position: absolute;
            width: 24px;
            height: 24px;
            cursor: pointer;
            z-index: 50; /* Au-dessus de tout */
            transform: translate(-50%, -100%); /* Positionnement du centre bas de l'√©pingle */
            transition: transform 0.2s ease-in-out;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            animation: pulse 1.5s infinite;
        }

        .poi-pin:hover {
            transform: translate(-50%, -100%) scale(1.2);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        /* Styles pour l'indicateur de chargement */
        .loading-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen p-4 flex flex-col items-center font-sans">

    <header class="text-center mb-8 w-full max-w-4xl">
        <h1 class="text-4xl font-extrabold text-blue-400">
            Explorateur Historique Multim√©dia d'Oraxia üöÄ
        </h1>
        <p class="text-xl text-gray-400 mt-2">
            Plongez dans l'√©volution de la carte et de l'histoire, saison apr√®s saison.
        </p>
    </header>

    <main class="w-full max-w-6xl mx-auto">
        
        <!-- Onglets de Navigation -->
        <div class="flex border-b border-gray-700 mb-6">
            <button onclick="showView('comparateur')" id="tab-comparateur"
                    class="tab-button py-2 px-4 text-sm sm:text-base font-medium text-white border-b-4 border-blue-400 transition-colors duration-200 bg-gray-800 rounded-t-lg">
                Carte & Comparaison
            </button>
            <button onclick="showView('chronologie')" id="tab-chronologie"
                    class="tab-button py-2 px-4 text-sm sm:text-base font-medium text-gray-400 border-b-4 border-transparent hover:border-blue-600 transition-colors duration-200 hover:text-white">
                Chronologie des Saisons
            </button>
            <button onclick="showView('personnages')" id="tab-personnages"
                    class="tab-button py-2 px-4 text-sm sm:text-base font-medium text-gray-400 border-b-4 border-transparent hover:border-blue-600 transition-colors duration-200 hover:text-white">
                Fiches Personnages
            </button>
        </div>

        <!-- Vues -->
        <div id="comparateur-view" class="view">
            <!-- S√©lecteurs de versions -->
            <div class="flex flex-col sm:flex-row justify-between gap-4 mb-6 p-4 bg-gray-800 rounded-xl shadow-lg border-2 border-gray-700">
                
                <div class="flex-1">
                    <label for="versionAvant" class="block text-sm font-medium text-red-400 mb-1">
                        Version AVANT (pour la comparaison) :
                    </label>
                    <select id="versionAvant" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-red-500 focus:border-red-500 transition-colors">
                        <!-- Options remplies par JS -->
                    </select>
                </div>
                
                <div class="flex-1">
                    <label for="versionApres" class="block text-sm font-medium text-green-400 mb-1">
                        Version APR√àS (Histoire & POI affich√©s) :
                    </label>
                    <select id="versionApres" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-green-500 focus:border-green-500 transition-colors">
                        <!-- Options remplies par JS -->
                    </select>
                </div>

            </div>

            <!-- Conteneur principal du slider et POI -->
            <div id="comparisonContainer" 
                 class="comparison-slider-container relative w-full aspect-video shadow-2xl rounded-xl overflow-hidden border-4 border-gray-700 bg-gray-800 transition-all duration-300 ease-in-out">

                <!-- Images de comparaison -->
                <img id="imageAvant" class="comparison-image absolute inset-0 z-10" src="" alt="Carte Avant Mise √† Jour">
                <div class="image-apres-wrapper absolute inset-0 z-20 overflow-hidden bg-gray-600">
                    <img id="imageApres" class="comparison-image absolute inset-0" src="" alt="Carte Apr√®s Mise √† Jour">
                </div>
                
                <!-- Conteneur des POI -->
                <div id="poiContainer" class="absolute inset-0 z-40 pointer-events-none">
                    <!-- Les √©pingles de POI seront ajout√©es ici par JS -->
                </div>

                <!-- La poign√©e (Handle) draggable/tactile -->
                <div id="sliderHandle" 
                     class="slider-handle absolute top-0 bottom-0 z-50 flex items-center justify-center 
                            text-white bg-transparent pointer-events-auto">
                    
                    <div class="handle-line h-full bg-white shadow-lg"></div>

                    <div class="handle-circle absolute bg-white p-1 rounded-full shadow-xl 
                                border-4 border-gray-900/50 hover:scale-110 transition-transform duration-150 ease-out">
                        <div class="handle-content text-gray-900">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                                <polyline points="15 17 20 12 15 7"></polyline>
                                <polyline points="9 17 4 12 9 7"></polyline>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- √âtiquettes de version dynamiques -->
                <div id="labelAvant" class="absolute top-3 left-3 p-1.5 bg-red-800/80 text-white text-xs font-bold rounded-lg z-60 shadow-md"></div>
                <div id="labelApres" class="absolute top-3 right-3 p-1.5 bg-green-800/80 text-white text-xs font-bold rounded-lg z-60 shadow-md"></div>
                
            </div>
            
            <!-- Panneau d'Information d'Histoire -->
            <div class="mt-8 p-6 w-full bg-gray-800 rounded-xl shadow-xl border-2 border-gray-700">
                <h2 class="text-2xl font-bold text-green-400 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    D√©tails de l'√âv√©nement : <span id="currentVersionName" class="text-white ml-2">...</span>
                </h2>
                
                <!-- Zone d'affichage des POI actifs -->
                <div id="activePoiInfo" class="p-4 mb-4 border border-blue-600 rounded-lg bg-blue-900/50 text-white hidden">
                    <h3 class="font-bold text-lg text-blue-300">Point d'Int√©r√™t Actif : <span id="poiName"></span></h3>
                    <p id="poiDescription" class="text-sm mt-1"></p>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- R√©sum√© de l'Histoire -->
                    <div>
                        <h3 id="historyTitle" class="text-xl font-semibold text-green-300 mb-2"></h3>
                        <p id="historyContent" class="text-gray-300 leading-relaxed min-h-[5rem]">
                            <!-- Contenu dynamique de l'histoire -->
                            <span class="text-center p-4 text-gray-500 italic">
                                Chargement de l'histoire...
                            </span>
                        </p>
                    </div>
                    
                    <!-- Personnages Cl√©s de la Saison -->
                    <div>
                        <h3 class="text-xl font-semibold text-red-300 mb-2">Personnages et Qu√™tes</h3>
                        <ul id="charactersList" class="space-y-1 text-gray-300 list-disc list-inside">
                            <!-- Liste des personnages/qu√™tes -->
                            <li>Chargement...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vue Chronologie -->
        <div id="chronologie-view" class="view hidden">
            <h2 class="text-3xl font-bold text-blue-400 mb-6 text-center">Chronologie des √âv√©nements Majeurs</h2>
            <div id="timelineContainer" class="relative">
                <!-- Ligne de temps -->
                <div class="absolute h-full w-1 bg-gray-700 left-1/2 transform -translate-x-1/2 hidden sm:block"></div>
                <!-- Les √©v√©nements de la chronologie seront g√©n√©r√©s ici par JS -->
            </div>
        </div>

        <!-- Vue Fiches Personnages -->
        <div id="personnages-view" class="view hidden">
            <h2 class="text-3xl font-bold text-blue-400 mb-6 text-center">Fiches de Personnages Cl√©s</h2>
            <div id="charactersGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les fiches de personnages seront g√©n√©r√©es ici par JS -->
            </div>
        </div>
        
    </main>
    
    <p class="mt-6 text-sm text-gray-500 max-w-4xl text-center">
        <span class="text-blue-400 font-bold">Conseil :</span> 
        Utilisez les onglets pour explorer l'histoire compl√®te d'Oraxia. Dans la vue carte, cliquez sur les marqueurs pour voir les d√©tails des Points d'Int√©r√™t !
    </p>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Donn√©es Centrales du Monde d'Oraxia ---
            
            // Points d'Int√©r√™t (POI) - Coordonn√©es en pourcentage (X=gauche, Y=haut)
            const poiData = [
                // POI pour toutes les versions
                { id: 'sanctuary', name: "Sanctuaire des Montagnes Divines", x: 65, y: 15, color: '#FCD34D', 
                  description: "Lieu o√π Moldar active la Pierre d'Oracle. Point de concentration d'√©nergie.", minVersion: 'v2' },
                { id: 'meteors', name: "Zone d'Impact des M√©t√©orites", x: 30, y: 70, color: '#EF4444', 
                  description: "Zone des premiers impacts, berceau des Pierres Runiques.", minVersion: 'v1' },
                { id: 'leaky_lake', name: "Leaky Lake (Laboratoires)", x: 45, y: 40, color: '#3B82F6', 
                  description: "Zone o√π les scientifiques ont men√© des √©tudes, notamment sous le lac.", minVersion: 'v1' },
                // POI sp√©cifiques aux versions ult√©rieures
                { id: 'grand_vide', name: "Canyon du Grand Vide", x: 75, y: 55, color: '#A855F7', 
                  description: "Portail vers la nouvelle r√©gion t√©n√©breuse et l'Arm√©e du Fl√©au.", minVersion: 'v6' },
                { id: 'fiefs_noirs', name: "Fiefs Noirs (Corruption)", x: 20, y: 25, color: '#10B981', 
                  description: "Zones corrompues par l'Arm√©e du Fl√©au et l'√©nergie du N√©an.", minVersion: 'v6' },
                { id: 'ankatar_teleport', name: "D√©but de la t√©l√©portation vers Ankatar", x: 55, y: 65, color: '#D946EF', 
                  description: "Point de la t√©l√©portation massive vers l'√Æle voisine √† la fin de la Saison 7.", minVersion: 'v7' },
            ];

            // Donn√©es des Saisons (Versions de Carte)
            const mapVersions = [
                { id: 'v1', name: "S1 : Alpha (v0.0)", url: "./Maps/alpha.png", 
                    story: { title: "Saison 1 : Myst√®re chez √òraxia", summary: "D√©couverte des terres alentours et m√©t√©orites ravageant le Royaume. Arriv√©e de nouveaux personnages (Cartographes, Habitants d'Oraxia). Les qu√™tes initiales consistent √† remplir la carte et √† dialoguer avec les populations r√©gionales.", 
                             characters: ["Cartographes (exploration)", "Habitants d'Oraxia (qu√™tes initiales)"],
                             quests: ["Remplir la carte donn√©e par le cartographe en parlant √† la population.", "Aider les scientifiques √† analyser la pierre des m√©t√©orites."]}}, 
                { id: 'v2', name: "S2 : Beta (v1.0)", url: "./Maps/beta.png", 
                    story: { title: "Saison 2 : Les Pierres d'√òraxia", summary: "Suite √† l'union des civilisations, une pluie de m√©t√©orites contenant des pierres runiques s'abat. Moldar et ses scientifiques se rendent au Sanctuaire dans les montagnes divines et activent la puissance de la Pierre d'Oracle, r√©v√©lant des pierres runiques partout. Les habitants se m√©fient du pouvoir des pierres.", 
                             characters: ["Moldar (Alchimiste pr√©dicteur)", "Scientifiques", "M√©t√©orologues"],
                             quests: ["Aider les scientifiques et Moldar √† trouver toutes les pierres runiques et √† les rassembler dans le Sanctuaire."]}
                },
                { id: 'v3', name: "S3 : Oraxoween (v1.1)", url: "./Maps/beta-v2.png", 
                    story: { title: "Saison 3 : Aux Pierres et √† la baguette", summary: "De nouveaux √©v√©nements paranormaux surviennent : magie, r√©gions corrompues... Des mages et de nouveaux personnages apparaissent. Le but est de trouver toutes les pierres, mais des secrets bien cach√©s sur Oraxia sont r√©v√©l√©s.", 
                             characters: ["Mages (nouveaux alli√©s/ennemis)", "Personnages S2"],
                             quests: ["Continuer la recherche des pierres runiques. D√©couvrir des secrets sur Oraxia."]}
                },
                { id: 'v4', name: "S4 : L'Orbe Du N√©an (v1.2)", url: "./Maps/beta-v3.png", 
                    story: { title: "Saison 4 : L'Orbe Du N√©an", summary: "Moldar r√©ussit √† r√©unir toutes les pierres dans un 'Stones Container', lui conf√©rant une partie de leur pouvoir pour cr√©er 'L'Orbe Du N√©an'. Il cherche les Cl√©s Dimensionnelles pour entrer dans 'l'Heaven' et s'emparer du 'Socle du N√©an'.", 
                             characters: ["Moldar (de plus en plus puissant)", "H√©ros (chercheurs de cl√©s)"],
                             quests: ["R√©cup√©rer les Cl√©s Dimensionnelles avant Moldar. Emp√™cher la cr√©ation de l'Orbe."]}
                },
                { id: 'v5', name: "S5 : Le Dieu Moldar (v1.3)", url: "./Maps/beta-v4.png", 
                    story: { title: "Saison 5 : Le Dieu Moldar", summary: "Moldar, ayant acquis tous les pouvoirs, devient un Dieu (Al Moldar) et finalise la cr√©ation de l'Orbe, mais son pouvoir le fait faiblir. Les h√©ros d√©cident de traverser le canyon du Grand Vide pour d√©couvrir une nouvelle r√©gion t√©n√©breuse.", 
                             characters: ["Al Moldar (le Dieu affaibli)", "Les H√©ros (explorateurs)"],
                             quests: ["D√©couvrir les cons√©quences de l'Orbe. Traverser le Grand Vide."]}
                },
                { id: 'v6', name: "S6 : L'Arm√©e du Fl√©au (v1.4)", url: "./Maps/beta-v5.png", 
                    story: { title: "Saison 6 : L'Arm√©e du Fl√©au", summary: "Le Grand Vide r√©v√®le l'arm√©e de cr√©atures t√©n√©breuses : 'L'arm√©e du Fl√©au', qui corrompt des zones de la carte (Les Fiefs Noirs). Une zone au milieu des R√©gions Froides semble immunis√©e, formant un cercle sans neige autour d'une cabane banale.", 
                             characters: ["L'Arm√©e du Fl√©au (antagoniste principal)", "Les d√©fenseurs d'Oraxia"],
                             quests: ["D√©fendre les r√©gions contre la corruption du Fl√©au. Enqu√™ter sur la zone immunis√©e dans les R√©gions Froides."]}
                },
                { id: 'v7', name: "S7 : D√©but d'Ankatar (v1.5)", url: "./Maps/beta-v6.png", 
                    story: { title: "Saison 7 : Le N√©an (D√©but d'Ankatar)", summary: "L'arm√©e du Fl√©au commence √† d√©former la r√©alit√© et la 'Pierre' active une t√©l√©portation massive. Les habitants sont d√©plac√©s sur l'√Æle voisine d'Ankatar. La Pierre se r√©v√®le √™tre un ancien vaisseau extraterrestre, aliment√© par le N√©an qui a fossilis√©.", 
                             characters: ["Les survivants d'Oraxia", "Anciens extraterrestres (r√©v√©lation)"],
                             quests: ["G√©rer la t√©l√©portation de masse vers Ankatar. D√©couvrir la v√©ritable nature de la Pierre."]}
                },
            ];
            
            // Fiches de Personnages (Agr√©gation des personnages mentionn√©s dans les histoires)
            const characterFiches = [
                { name: "Moldar / Al Moldar", role: "Alchimiste, puis Dieu", debut: "Saison 1.5/2", evolution: "Passe d'un chercheur √† un √™tre divin par l'acquisition du pouvoir des Pierres Runiques, puis est affaibli par le N√©an. Antagoniste complexe.", color: 'bg-yellow-600' },
                { name: "Les Cartographes", role: "Explorateurs / Guides", debut: "Saison 1", evolution: "Essentiels √† l'exploration initiale du royaume. Leur r√¥le √©volue vers le conseil et la planification face aux menaces.", color: 'bg-blue-600' },
                { name: "L'Arm√©e du Fl√©au", role: "Force Corruptrice", debut: "Saison 6", evolution: "Arm√©e t√©n√©breuse r√©v√©l√©e par le Canyon du Grand Vide, responsable de la corruption des Fiefs Noirs et de la d√©formation de la r√©alit√©.", color: 'bg-purple-600' },
                { name: "Les Scientifiques", role: "Chercheurs / Analystes", debut: "Saison 1", evolution: "Initialement centr√©s sur les m√©t√©orites, ils √©tudient les Pierres Runiques, l'Orbe du N√©an, et sont les premiers √† comprendre la nature de la Pierre/Vaisseau extraterrestre.", color: 'bg-green-600' },
                // Ajoutez d'autres personnages ici...
            ];


            const FALLBACK_PLACEHOLDER = "https://placehold.co/1024x576/374151/D1D5DB?text=ERREUR+DE+CHARGEMENT";
            const MIN_SCALE = 1.0;
            const MAX_SCALE = 5.0;
            const SCALE_STEP = 0.15;
            const PAN_MARGIN_PERCENT = 0.5;
            
            const DOUBLE_TAP_THRESHOLD = 300; 
            let lastTapTime = 0;
            const ZOOM_LEVEL_ON_DOUBLE_TAP = 2.5; 
            
            // --- √âl√©ments du DOM ---
            const container = document.getElementById('comparisonContainer');
            const handle = document.getElementById('sliderHandle');
            const selectAvant = document.getElementById('versionAvant');
            const selectApres = document.getElementById('versionApres');
            const imageAvant = document.getElementById('imageAvant');
            const imageApres = document.getElementById('imageApres');
            const labelAvant = document.getElementById('labelAvant');
            const labelApres = document.getElementById('labelApres');
            const poiContainer = document.getElementById('poiContainer');
            const style = container.style;
            
            // √âl√©ments d'histoire
            const currentVersionName = document.getElementById('currentVersionName');
            const historyTitle = document.getElementById('historyTitle');
            const historyContent = document.getElementById('historyContent');
            const charactersList = document.getElementById('charactersList');
            const activePoiInfo = document.getElementById('activePoiInfo');
            const poiNameDisplay = document.getElementById('poiName');
            const poiDescriptionDisplay = document.getElementById('poiDescription');

            // Vues et Onglets
            const views = document.querySelectorAll('.view');
            const tabs = document.querySelectorAll('.tab-button');
            const timelineContainer = document.getElementById('timelineContainer');
            const charactersGrid = document.getElementById('charactersGrid');
            
            // --- Variables d'√âtat ---
            let isSliderDragging = false; 
            let isPanDragging = false;    
            let containerRect;            
            let lastX = 0;
            let lastY = 0;   
            let initialDistance = 0;
            let initialScale = MIN_SCALE;

            let viewState = {
                scale: MIN_SCALE, 
                offsetX: 0,       
                offsetY: 0        
            };

            // --- Fonctions de Navigation ---

            window.showView = (viewId) => {
                views.forEach(view => {
                    view.classList.add('hidden');
                });
                document.getElementById(`${viewId}-view`).classList.remove('hidden');

                tabs.forEach(tab => {
                    tab.classList.remove('bg-gray-800', 'text-white', 'border-blue-400');
                    tab.classList.add('text-gray-400', 'border-transparent');
                });
                const activeTab = document.getElementById(`tab-${viewId}`);
                activeTab.classList.add('bg-gray-800', 'text-white', 'border-blue-400');
                activeTab.classList.remove('text-gray-400', 'border-transparent');

                if (viewId === 'chronologie' && timelineContainer.children.length === 0) {
                    generateTimeline();
                }
                 if (viewId === 'personnages' && charactersGrid.children.length === 0) {
                    generateCharacterFiches();
                }
            };

            // --- Logique du Zoom/Panoramique (inchang√©e) ---
            
            function getDistance(touches) {
                if (touches.length < 2) return 0;
                return Math.hypot(
                    touches[1].clientX - touches[0].clientX, 
                    touches[1].clientY - touches[0].clientY
                );
            }

            function updateImageTransform() {
                const transform = `translate(${viewState.offsetX}px, ${viewState.offsetY}px) scale(${viewState.scale})`;
                imageAvant.style.transform = transform;
                imageApres.style.transform = transform;
                // Appliquer aussi aux POI
                poiContainer.style.transform = transform; 
            }

            function clampPan() {
                if (!containerRect) containerRect = container.getBoundingClientRect();

                if (viewState.scale <= MIN_SCALE) {
                    viewState.offsetX = 0;
                    viewState.offsetY = 0;
                } else {
                    const scaledWidth = containerRect.width * viewState.scale;
                    const scaledHeight = containerRect.height * viewState.scale;

                    const marginX = containerRect.width * PAN_MARGIN_PERCENT;
                    const marginY = containerRect.height * PAN_MARGIN_PERCENT;

                    const maxPanX = marginX; 
                    const minPanX = containerRect.width - scaledWidth - marginX; 
                    
                    const maxPanY = marginY;
                    const minPanY = containerRect.height - scaledHeight - marginY;


                    viewState.offsetX = Math.max(minPanX, Math.min(maxPanX, viewState.offsetX));
                    viewState.offsetY = Math.max(minPanY, Math.min(maxPanY, viewState.offsetY));
                }

                updateImageTransform();
            }

            function handleZoom(e) {
                e.preventDefault(); 
                
                const delta = e.deltaY < 0 ? SCALE_STEP : -SCALE_STEP;

                let newScale = viewState.scale + delta;
                newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, newScale));

                if (newScale === viewState.scale) return;

                containerRect = container.getBoundingClientRect();
                const mouseX = e.clientX - containerRect.left;
                const mouseY = e.clientY - containerRect.top;

                const zoomFactor = newScale / viewState.scale;

                viewState.offsetX = mouseX - (mouseX - viewState.offsetX) * zoomFactor;
                viewState.offsetY = mouseY - (mouseY - viewState.offsetY) * zoomFactor;
                
                viewState.scale = newScale;
                clampPan(); 
            }
            
            function handleDoubleTapZoom(e) {
                const clientX = e.clientX || (e.touches ? e.touches[0].clientX : null);
                const clientY = e.clientY || (e.touches ? e.touches[0].clientY : null);
                
                if (clientX === null || clientY === null) return;

                containerRect = container.getBoundingClientRect();
                const centerX = containerRect.width / 2;
                const centerY = containerRect.height / 2;
                
                if (viewState.scale > MIN_SCALE) {
                    viewState.scale = MIN_SCALE;
                    viewState.offsetX = 0;
                    viewState.offsetY = 0;
                } else {
                    viewState.scale = ZOOM_LEVEL_ON_DOUBLE_TAP;
                    
                    const focalX = clientX - containerRect.left;
                    const focalY = clientY - containerRect.top;

                    viewState.offsetX = centerX - (focalX * viewState.scale);
                    viewState.offsetY = centerY - (focalY * viewState.scale);
                }

                clampPan(); 
            }

            function updateSliderPosition(clientX) {
                if (!containerRect) {
                    containerRect = container.getBoundingClientRect();
                }
                
                let position = clientX - containerRect.left;
                position = Math.max(0, Math.min(position, containerRect.width));
                
                const percent = (position / containerRect.width) * 100;
                style.setProperty('--position', `${percent}%`);
            }
            
            // --- Logique de Glissement (Drag) ---

            const startSliderDrag = (e) => {
                if (e.currentTarget !== handle) return;

                isSliderDragging = true;
                handle.style.cursor = 'grabbing';
                container.style.cursor = 'grabbing';
                containerRect = container.getBoundingClientRect();
                
                if (e.type.startsWith('touch')) { e.preventDefault(); }
                e.stopPropagation(); 
            };

            const startPanDrag = (e) => {
                if (e.target === handle || handle.contains(e.target) || isSliderDragging) return;
                
                // Double Tap/Click Logic
                if (e.touches && e.touches.length === 1 || !e.touches) {
                    const currentTime = new Date().getTime();
                    const timeDiff = currentTime - lastTapTime;

                    if (timeDiff < DOUBLE_TAP_THRESHOLD && timeDiff > 0) {
                        e.preventDefault(); 
                        handleDoubleTapZoom(e);
                        lastTapTime = 0; 
                        return;
                    }
                    lastTapTime = currentTime;
                }
                
                // Pinch Start Logic (2 fingers)
                if (e.touches && e.touches.length === 2) {
                    initialDistance = getDistance(e.touches);
                    initialScale = viewState.scale;
                    e.preventDefault(); 
                    return;
                }
                
                // Pan Start Logic (1 finger or mouse)
                if (viewState.scale === MIN_SCALE) return;

                isPanDragging = true;
                container.classList.add('cursor-grabbing'); 
                containerRect = container.getBoundingClientRect();

                lastX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                lastY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
                
                if (e.touches) e.preventDefault(); 
            };
            
            const onDrag = (e) => {
                // Pinch-to-Zoom Logic (2 fingers)
                if (e.touches && e.touches.length === 2) {
                    e.preventDefault(); 
                    isSliderDragging = false; 
                    isPanDragging = false;
                    
                    if (initialDistance === 0) {
                        initialDistance = getDistance(e.touches);
                        initialScale = viewState.scale;
                        return;
                    }

                    const newDistance = getDistance(e.touches);
                    let newScale = initialScale * (newDistance / initialDistance);
                    
                    newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, newScale));

                    if (newScale !== viewState.scale) {
                        const previousScale = viewState.scale;
                        
                        containerRect = container.getBoundingClientRect();
                        const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                        const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2;

                        const focalX = centerX - containerRect.left;
                        const focalY = centerY - containerRect.top;
                        
                        const zoomFactor = newScale / previousScale; 
                        viewState.offsetX = focalX - (focalX - viewState.offsetX) * zoomFactor;
                        viewState.offsetY = focalY - (focalY - viewState.offsetY) * zoomFactor;
                        
                        viewState.scale = newScale;
                    }
                    
                    clampPan();
                    return; 
                }
                
                // Slider/Pan Drag Logic (1 finger or mouse)
                if (!isSliderDragging && !isPanDragging) return;

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                if (isSliderDragging) {
                    updateSliderPosition(clientX);
                }
                
                if (isPanDragging) {
                    const dx = clientX - lastX;
                    const dy = clientY - lastY;
                    
                    viewState.offsetX += dx;
                    viewState.offsetY += dy;

                    clampPan();

                    lastX = clientX;
                    lastY = clientY;
                }
                
                if (e.touches) { e.preventDefault(); }
            };

            const endDrag = () => {
                isSliderDragging = false;
                isPanDragging = false;
                
                initialDistance = 0; 
                initialScale = MIN_SCALE;

                handle.style.cursor = 'grab';
                container.style.cursor = 'grab';
                container.classList.remove('cursor-grabbing');
            };

            // --- Logique des POI (Points d'Int√©r√™t) ---

            /**
             * Affiche ou masque les informations du POI survol√©/cliqu√©.
             * @param {Object} poi - Les donn√©es du POI.
             */
            function displayPoiInfo(poi) {
                poiNameDisplay.textContent = poi.name;
                poiDescriptionDisplay.textContent = poi.description;
                activePoiInfo.classList.remove('hidden');
            }

            /**
             * Masque les informations du POI.
             */
            function hidePoiInfo() {
                activePoiInfo.classList.add('hidden');
                poiNameDisplay.textContent = '';
                poiDescriptionDisplay.textContent = '';
            }
            
            /**
             * G√©n√®re les √©pingles de POI pour la version de carte actuelle.
             */
            function renderPois(currentVersionId) {
                // Trouver l'index de la version actuelle pour la comparaison
                const currentVersionIndex = mapVersions.findIndex(v => v.id === currentVersionId);
                poiContainer.innerHTML = '';
                poiContainer.classList.remove('pointer-events-none');
                poiContainer.classList.add('pointer-events-auto');

                poiData.forEach(poi => {
                    const minVersionIndex = mapVersions.findIndex(v => v.id === poi.minVersion);
                    
                    // N'afficher le POI que s'il est actif dans la version courante
                    if (currentVersionIndex >= minVersionIndex) {
                        const pin = document.createElement('div');
                        pin.className = 'poi-pin';
                        pin.style.left = `${poi.x}%`;
                        pin.style.top = `${poi.y}%`;
                        pin.style.backgroundColor = poi.color;
                        pin.title = poi.name;
                        
                        // Ajoutez un marqueur central
                        pin.innerHTML = `
                            <svg class="w-full h-full text-white p-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                        `;

                        // √âv√©nements pour les d√©tails du POI
                        pin.addEventListener('mouseover', () => displayPoiInfo(poi));
                        pin.addEventListener('mouseout', hidePoiInfo);
                        pin.addEventListener('click', () => displayPoiInfo(poi));
                        
                        poiContainer.appendChild(pin);
                    }
                });
            }

            // --- Logique d'Initialisation et de Mise √† Jour ---

            function updateHistoryPanel(versionId) {
                const version = mapVersions.find(v => v.id === versionId);
                
                if (version && version.story) {
                    currentVersionName.textContent = version.name;
                    historyTitle.textContent = version.story.title || `Histoire de la version : ${version.name}`;
                    historyContent.textContent = version.story.summary;
                    
                    // Mise √† jour de la liste des personnages/qu√™tes
                    charactersList.innerHTML = '';
                    const allDetails = [...version.story.characters, ...version.story.quests];
                    
                    if (allDetails.length > 0) {
                        allDetails.forEach(detail => {
                            const li = document.createElement('li');
                            li.textContent = detail;
                            charactersList.appendChild(li);
                        });
                    } else {
                        charactersList.innerHTML = '<li>Aucun d√©tail sp√©cifique trouv√© pour cette version.</li>';
                    }
                    
                } else {
                    // Gestion du cas o√π l'histoire est manquante
                    currentVersionName.textContent = 'Non d√©finie';
                    historyTitle.textContent = 'Histoire non disponible';
                    historyContent.textContent = 'Aucune information d\'histoire disponible pour cette version.';
                    charactersList.innerHTML = '<li>...</li>';
                }
                
                // Mettre √† jour les POI bas√©s sur la version s√©lectionn√©e
                renderPois(versionId);
                hidePoiInfo();
            }


            function populateSelects() {
                mapVersions.forEach(version => {
                    const optionAvant = new Option(version.name, version.id);
                    const optionApres = new Option(version.name, version.id);
                    selectAvant.add(optionAvant);
                    selectApres.add(optionApres);
                });

                if (mapVersions.length >= 2) {
                    selectAvant.value = mapVersions[mapVersions.length - 2].id;
                    selectApres.value = mapVersions[mapVersions.length - 1].id;
                } else if (mapVersions.length === 1) {
                    selectAvant.value = mapVersions[0].id;
                    selectApres.value = mapVersions[0].id;
                }
                
                updateImagesAndLabels();
                updateHistoryPanel(selectApres.value);
            }

            function updateImagesAndLabels() {
                const idAvant = selectAvant.value;
                const idApres = selectApres.value;

                const versionA = mapVersions.find(v => v.id === idAvant);
                const versionB = mapVersions.find(v => v.id === idApres);
                
                const COLOR_CLASSES = {
                    avant: { success: 'bg-red-800/80', error: 'bg-gray-600/90' },
                    apres: { success: 'bg-green-800/80', error: 'bg-gray-600/90' }
                };

                const loadImage = (imgElement, version, labelElement, baseType) => {
                    if (!version) return;
                    
                    const colorSet = COLOR_CLASSES[baseType];
                    
                    labelElement.textContent = version.name;
                    labelElement.classList.remove(colorSet.error);
                    labelElement.classList.add(colorSet.success);

                    imgElement.onerror = () => {
                        console.error(`[Erreur de Chargement] √âchec du chargement de l'image : ${version.name} √† ${version.url}`);
                        imgElement.src = FALLBACK_PLACEHOLDER;
                        imgElement.alt = `Carte ${version.name} (Erreur de chargement)`;
                        labelElement.textContent = `${version.name} (Erreur)`;
                        labelElement.classList.remove(colorSet.success);
                        labelElement.classList.add(colorSet.error);
                        imgElement.onerror = null; 
                    };

                    imgElement.onload = () => {
                        imgElement.onerror = null; 
                        labelElement.classList.remove(colorSet.error);
                        labelElement.classList.add(colorSet.success);
                        labelElement.textContent = version.name;
                    };

                    imgElement.src = version.url;
                    imgElement.alt = `Carte ${version.name}`;
                };

                loadImage(imageAvant, versionA, labelAvant, 'avant');
                loadImage(imageApres, versionB, labelApres, 'apres');
                
                updateHistoryPanel(idApres);
            }
            
            const initializePosition = () => {
                viewState.scale = MIN_SCALE;
                viewState.offsetX = 0;
                viewState.offsetY = 0;
                updateImageTransform();
                
                containerRect = container.getBoundingClientRect();
                const center = containerRect.width / 2;
                updateSliderPosition(containerRect.left + center);
            };

            // --- Logique de la Chronologie (Timeline) ---
            function generateTimeline() {
                timelineContainer.innerHTML = '';
                
                mapVersions.forEach((version, index) => {
                    const isLeft = index % 2 === 0;
                    const side = isLeft ? 'left' : 'right';
                    const versionNumber = index + 1;

                    const eventDiv = document.createElement('div');
                    eventDiv.className = `timeline-item mb-8 flex ${isLeft ? 'justify-start sm:justify-start' : 'justify-start sm:justify-end'}`;

                    // D√©calage pour le mobile (toujours √† gauche, pas de ligne centrale)
                    eventDiv.innerHTML = `
                        <div class="relative w-full sm:w-1/2 p-4 rounded-xl shadow-lg transition-transform duration-300 transform hover:scale-[1.02] cursor-pointer bg-gray-800 border-l-4 ${isLeft ? 'sm:border-r-4 sm:border-l-0 border-blue-400' : 'border-green-400'}">
                            
                            <!-- Cercle sur la ligne centrale (Desktop seulement) -->
                            <div class="hidden sm:block absolute w-4 h-4 rounded-full ${isLeft ? 'right-[-2.35rem]' : 'left-[-2.35rem]'} top-4 bg-gray-900 border-4 border-blue-400 z-10"></div>
                            
                            <!-- Contenu -->
                            <p class="text-sm font-bold text-gray-500 mb-1">${version.name}</p>
                            <h3 class="text-xl font-semibold ${isLeft ? 'text-red-400' : 'text-green-400'}">${version.story.title}</h3>
                            <p class="text-gray-300 mt-2 text-sm">${version.story.summary}</p>
                            
                            <!-- Marqueur de saison (Mobile) -->
                            <div class="sm:hidden absolute top-0 left-[-1.5rem] w-3 h-3 rounded-full bg-blue-400 border-2 border-gray-900"></div>

                        </div>
                    `;

                    // Ajout du listener pour changer la vue sur la carte
                    eventDiv.addEventListener('click', () => {
                        selectApres.value = version.id;
                        selectAvant.value = mapVersions[Math.max(0, index - 1)].id;
                        updateImagesAndLabels();
                        showView('comparateur');
                    });

                    timelineContainer.appendChild(eventDiv);
                });
            }

            // --- Logique des Fiches Personnages ---
            function generateCharacterFiches() {
                charactersGrid.innerHTML = '';

                characterFiches.forEach(char => {
                    const card = document.createElement('div');
                    card.className = `${char.color} p-6 rounded-xl shadow-2xl transform hover:scale-[1.02] transition-transform duration-300 border-t-8 border-white/20`;

                    card.innerHTML = `
                        <div class="flex items-center mb-3">
                            <svg class="w-8 h-8 mr-3 text-white" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                            <h3 class="text-2xl font-bold text-white">${char.name}</h3>
                        </div>
                        <p class="text-sm italic text-gray-200 mb-2">R√¥le Principal : ${char.role}</p>
                        <p class="text-sm font-semibold text-gray-100 mb-4">Appara√Æt d√®s : ${char.debut}</p>
                        <p class="text-gray-300">${char.evolution}</p>
                    `;

                    charactersGrid.appendChild(card);
                });
            }

            // --- Attacher les √©couteurs d'√©v√©nements ---
            
            selectAvant.addEventListener('change', updateImagesAndLabels);
            selectApres.addEventListener('change', updateImagesAndLabels);

            handle.addEventListener('mousedown', startSliderDrag);
            handle.addEventListener('touchstart', startSliderDrag);

            container.addEventListener('mousedown', startPanDrag);
            container.addEventListener('touchstart', startPanDrag);

            container.addEventListener('wheel', handleZoom, { passive: false });
            
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('touchmove', onDrag, { passive: false }); 
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
            
            
            // Initialisation de la page
            window.addEventListener('load', () => {
                populateSelects(); 
                initializePosition(); 
                showView('comparateur'); // Vue par d√©faut
            });
            window.addEventListener('resize', initializePosition);
        });

    </script>
</body>
</html>

